---
title: "Hands-on Exercise 13: Creating Ternary Plot with R"
author: "Bao Sihan"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
execute:
  warning: false
  message: false
---

## 13.1 Overview

Ternary plots are useful for **three-part compositional data** (e.g., *Young / Active / Old* population shares) where each observation is expressed as proportions that sum to 1 (or 100%).

In this hands-on, we will:

-   load required packages,
-   wrangle the Singapore residents dataset into three measures (Young, Active, Old),
-   create a **static ternary plot** using **ggtern**,
-   create an **interactive ternary plot** using **plotly**.

## 13.2 Installing and launching R packages

```{r}
pacman::p_load(plotly, ggtern, tidyverse)
```

## 13.3 Data Preparation

### 13.3.1 Importing data

> The dataset file is expected to be in `data/` folder.\
> If your file path is different, update it accordingly.

```{r}
pop_data <- read_csv("../data/respopagsex2000to2018_tidy.csv")
```

### 13.3.2 Preparing the data

We reshape the age group column into multiple columns (wide format) and derive:

-   **YOUNG**: sum of age groups (0–19),
-   **ACTIVE**: sum of age groups (20–64),
-   **OLD**: sum of age groups (65+),
-   **TOTAL**: overall total across all age groups.

Then we keep **Year = 2018** (you can switch to other years).

```{r}
agpop_mutated <- pop_data %>%
  mutate(Year = as.character(Year)) %>%
  spread(AG, Population) %>%
  mutate(
    YOUNG  = rowSums(.[4:8],  na.rm = TRUE),
    ACTIVE = rowSums(.[9:16], na.rm = TRUE),
    OLD    = rowSums(.[17:21], na.rm = TRUE),
    TOTAL  = YOUNG + ACTIVE + OLD
  ) %>%
  filter(Year == "2018") %>%
  filter(TOTAL > 0)
```

## 13.4 Plotting Ternary Diagram with R

### 13.4.1 Plotting a static ternary diagram

Start with a minimal ternary scatter plot.

```{r}
ggtern(data = agpop_mutated, aes(x = YOUNG, y = ACTIVE, z = OLD)) +
  geom_point()
```

Add title and a cleaner theme.

```{r}
ggtern(data = agpop_mutated, aes(x = YOUNG, y = ACTIVE, z = OLD)) +
  geom_point() +
  labs(title = "Population structure, 2018") +
  theme_rgbw()
```

### 13.4.2 Plotting an interactive ternary diagram (plotly)

We define small helper functions for annotation and axis formatting, then build a `scatterternary` chart.

```{r}
# reusable function for creating annotation object
label <- function(txt) {
  list(
    text = txt,
    x = 0.1, y = 1,
    ax = 0, ay = 0,
    xref = "paper", yref = "paper",
    align = "center",
    font = list(family = "serif", size = 15, color = "white"),
    bgcolor = "#b3b3b3",
    bordercolor = "black",
    borderwidth = 2
  )
}

# reusable function for axis formatting
axis <- function(txt) {
  list(
    title = txt,
    tickformat = ".0%",
    tickfont = list(size = 10)
  )
}

ternaryAxes <- list(
  aaxis = axis("Young"),
  baxis = axis("Active"),
  caxis = axis("Old")
)

plot_ly(
  agpop_mutated,
  a = ~YOUNG,
  b = ~ACTIVE,
  c = ~OLD,
  type = "scatterternary",
  mode = "markers"
) %>%
  layout(
    annotations = label("Ternary Markers"),
    ternary = ternaryAxes
  )
```

## Notes / Tips

-   If your points look “squeezed”, try converting counts to proportions first, e.g. `YOUNG/TOTAL`, etc.
-   You can encode categories (e.g., *Planning Area*) using `color = ~PA` in `plot_ly()` or aesthetic mapping in `ggtern()`.
