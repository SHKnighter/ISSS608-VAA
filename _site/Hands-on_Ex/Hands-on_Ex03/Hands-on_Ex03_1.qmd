---
title: "Hands-on Exercise 3_1"
author: "Bao Sihan"
---

# 3.1 Learning Outcome

In this hands-on exercise, I learn how to create **interactive** data visualisation by using functions provided by **ggiraph** and **plotly**.

# 3.2 Getting Started

First, I check, install and load the required R packages.

```{r}
pacman::p_load(ggiraph, plotly, patchwork, DT, tidyverse)
```

# 3.3 Importing Data

I use `Exam_data.csv` in this exercise.

```{r}
exam_data <- read_csv("data/Exam_data.csv")
```

# 3.4 Interactive Data Visualisation - ggiraph methods

`ggiraph` is a ggplot2 extension and it allows ggplot graphics to be interactive.

## 3.4.1 Tooltip effect with tooltip aesthetic

The code chunk has two parts:\
(1) create a ggplot object, (2) use `girafe()` to display it.

```{r}
p <- ggplot(data = exam_data,
            aes(x = MATHS)) +
  geom_dotplot_interactive(
    aes(tooltip = ID),
    stackgroups = TRUE,
    binwidth = 1,
    method = "histodot"
  ) +
  scale_y_continuous(NULL, breaks = NULL)

girafe(
  ggobj = p,
  width_svg = 6,
  height_svg = 6 * 0.618
)
```

# 3.5 Interactivity

When I hover on a point, the student's ID will show.

## 3.5.1 Displaying multiple information on tooltip

Here I create a new field `tooltip` and include both `ID` and `CLASS`.

```{r}
exam_data$tooltip <- c(paste0(
  "Name = ", exam_data$ID,
  "
 Class = ", exam_data$CLASS
))

p <- ggplot(data = exam_data,
            aes(x = MATHS)) +
  geom_dotplot_interactive(
    aes(tooltip = exam_data$tooltip),
    stackgroups = TRUE,
    binwidth = 1,
    method = "histodot"
  ) +
  scale_y_continuous(NULL, breaks = NULL)

girafe(
  ggobj = p,
  width_svg = 8,
  height_svg = 8 * 0.618
)
```

# 3.6 Interactivity

In this section, I try tooltip style, hover effect and click effect.

## 3.6.1 Customising Tooltip style

I use `opts_tooltip()` to customise tooltip rendering with css.

```{r}
tooltip_css <- "background-color:white;
font-style:bold; color:black;"

p <- ggplot(data = exam_data,
            aes(x = MATHS)) +
  geom_dotplot_interactive(
    aes(tooltip = ID),
    stackgroups = TRUE,
    binwidth = 1,
    method = "histodot"
  ) +
  scale_y_continuous(NULL, breaks = NULL)

girafe(
  ggobj = p,
  width_svg = 6,
  height_svg = 6 * 0.618,
  options = list(
    opts_tooltip(css = tooltip_css)
  )
)
```

## 3.6.2 Displaying statistics on tooltip

This example uses a function to compute the mean and +/- value (mean_se), then show it on tooltip.

```{r}
tooltip <- function(y, ymax, accuracy = .01) {
  mean <- scales::number(y, accuracy = accuracy)
  sem <- scales::number(ymax - y, accuracy = accuracy)
  paste("Mean maths scores:", mean, "+/-", sem)
}

gg_point <- ggplot(data = exam_data,
                   aes(x = RACE)) +
  stat_summary(
    aes(y = MATHS,
        tooltip = after_stat(tooltip(y, ymax))),
    fun.data = "mean_se",
    geom = GeomInteractiveCol,
    fill = "light blue"
  ) +
  stat_summary(
    aes(y = MATHS),
    fun.data = mean_se,
    geom = "errorbar",
    width = 0.2,
    linewidth = 0.3
  )

girafe(
  ggobj = gg_point,
  width_svg = 8,
  height_svg = 8 * 0.618
)
```

## 3.6.3 Hover effect with data_id aesthetic

`data_id` is used to link elements. The points will highlight when mouse over.

```{r}
p <- ggplot(data = exam_data,
            aes(x = MATHS)) +
  geom_dotplot_interactive(
    aes(data_id = CLASS),
    stackgroups = TRUE,
    binwidth = 1,
    method = "histodot"
  ) +
  scale_y_continuous(NULL, breaks = NULL)

girafe(
  ggobj = p,
  width_svg = 6,
  height_svg = 6 * 0.618
)
```

## 3.6.4 Styling hover effect

Here I change the hover effect by using `opts_hover()` and `opts_hover_inv()`.

```{r}
p <- ggplot(data = exam_data,
            aes(x = MATHS)) +
  geom_dotplot_interactive(
    aes(data_id = CLASS),
    stackgroups = TRUE,
    binwidth = 1,
    method = "histodot"
  ) +
  scale_y_continuous(NULL, breaks = NULL)

girafe(
  ggobj = p,
  width_svg = 6,
  height_svg = 6 * 0.618,
  options = list(
    opts_hover(css = "fill: #202020;"),
    opts_hover_inv(css = "opacity:0.2;")
  )
)
```

## 3.6.5 Combining tooltip and hover effect

```{r}
p <- ggplot(data = exam_data,
            aes(x = MATHS)) +
  geom_dotplot_interactive(
    aes(tooltip = CLASS,
        data_id = CLASS),
    stackgroups = TRUE,
    binwidth = 1,
    method = "histodot"
  ) +
  scale_y_continuous(NULL, breaks = NULL)

girafe(
  ggobj = p,
  width_svg = 6,
  height_svg = 6 * 0.618,
  options = list(
    opts_hover(css = "fill: #202020;"),
    opts_hover_inv(css = "opacity:0.2;")
  )
)
```

## 3.6.6 Click effect with onclick

`onclick` provides hotlink interactivity.\
Here I use it to open a web link when clicking a point.

```{r}
exam_data$onclick <- sprintf(
  "window.open(\"%s%s\")",
  "https://www.moe.gov.sg/schoolfinder?journey=Primary%20school",
  as.character(exam_data$ID)
)

p <- ggplot(data = exam_data,
            aes(x = MATHS)) +
  geom_dotplot_interactive(
    aes(onclick = onclick),
    stackgroups = TRUE,
    binwidth = 1,
    method = "histodot"
  ) +
  scale_y_continuous(NULL, breaks = NULL)

girafe(
  ggobj = p,
  width_svg = 6,
  height_svg = 6 * 0.618
)
```

## 3.6.7 Coordinated Multiple Views with ggiraph

To link observations between plots, I use the same `data_id = ID` in both plots, then combine them by patchwork inside `girafe()`.

```{r}
p1 <- ggplot(data = exam_data,
             aes(x = MATHS)) +
  geom_dotplot_interactive(
    aes(data_id = ID),
    stackgroups = TRUE,
    binwidth = 1,
    method = "histodot"
  ) +
  coord_cartesian(xlim = c(0, 100)) +
  scale_y_continuous(NULL, breaks = NULL)

p2 <- ggplot(data = exam_data,
             aes(x = ENGLISH)) +
  geom_dotplot_interactive(
    aes(data_id = ID),
    stackgroups = TRUE,
    binwidth = 1,
    method = "histodot"
  ) +
  coord_cartesian(xlim = c(0, 100)) +
  scale_y_continuous(NULL, breaks = NULL)

girafe(
  code = print(p1 + p2),
  width_svg = 6,
  height_svg = 3,
  options = list(
    opts_hover(css = "fill: #202020;"),
    opts_hover_inv(css = "opacity:0.2;")
  )
)
```

# 3.7 Interactive Data Visualisation - plotly methods!

There are two common ways:

-   create directly by using `plot_ly()`,
-   convert a ggplot by using `ggplotly()`.

## 3.7.1 Creating an interactive scatter plot: plot_ly() method

```{r}
plot_ly(data = exam_data,
        x = ~MATHS,
        y = ~ENGLISH)
```

## 3.7.2 Working with visual variable: plot_ly() method

Here I map colour to `RACE`.

```{r}
plot_ly(data = exam_data,
        x = ~ENGLISH,
        y = ~MATHS,
        color = ~RACE)
```

## 3.7.3 Creating an interactive scatter plot: ggplotly() method

```{r}
p <- ggplot(data = exam_data,
            aes(x = MATHS,
                y = ENGLISH)) +
  geom_point(size = 1) +
  coord_cartesian(xlim = c(0, 100),
                  ylim = c(0, 100))

ggplotly(p)
```

## 3.7.4 Coordinated Multiple Views with plotly

Steps: - use `highlight_key()` to create shared data, - build two ggplots, - use `subplot()` to place them side-by-side.

```{r}
d <- highlight_key(exam_data)

p1 <- ggplot(data = d,
             aes(x = MATHS,
                 y = ENGLISH)) +
  geom_point(size = 1) +
  coord_cartesian(xlim = c(0, 100),
                  ylim = c(0, 100))

p2 <- ggplot(data = d,
             aes(x = MATHS,
                 y = SCIENCE)) +
  geom_point(size = 1) +
  coord_cartesian(xlim = c(0, 100),
                  ylim = c(0, 100))

subplot(ggplotly(p1),
        ggplotly(p2))
```

# 3.8 Interactive Data Visualisation - crosstalk methods!

## 3.8.1 Interactive Data Table: DT package

```{r}
DT::datatable(exam_data, class = "compact")
```

## 3.8.2 Linked brushing: crosstalk method

Here I use plotly highlight and DT together.

```{r}
d <- highlight_key(exam_data)

p <- ggplot(d,
            aes(ENGLISH, MATHS)) +
  geom_point(size = 1) +
  coord_cartesian(xlim = c(0, 100),
                  ylim = c(0, 100))

gg <- highlight(ggplotly(p),
                "plotly_selected")

crosstalk::bscols(gg,
                  DT::datatable(d),
                  widths = 5)
```

# 3.9 Reference

-   ggiraph
-   plotly for R
